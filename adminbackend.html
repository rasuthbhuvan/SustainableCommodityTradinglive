<!-- ==================  admin.html  ================== -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commodity Trading ‚Äì Admin Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* *******  IDENTICAL CSS  ******* */
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Poppins',sans-serif;background:#f5f5f5;min-height:100vh;color:#333}
        .mode-toggle{position:fixed;top:20px;right:20px;z-index:2000;background:#FFB400;color:#333;border:none;padding:12px 24px;border-radius:5px;cursor:pointer;font-weight:600;transition:.3s}
        .mode-toggle:hover{background:#e6a200}

        /* ----------  ADMIN LAYOUT  ---------- */
        .admin-container{display:flex;min-height:100vh}
        .sidebar{width:280px;background:linear-gradient(135deg,#2d3748,#1a202c);color:#fff;padding:20px 0;position:fixed;height:100vh;overflow-y:auto}
        .sidebar-header{padding:0 20px 30px;border-bottom:1px solid rgba(255,255,255,.1);margin-bottom:20px}
        .sidebar-header h2{color:#FFB400;font-weight:700;font-size:1.5rem}
        .sidebar-header p{color:rgba(255,255,255,.7);font-size:.9rem;margin-top:5px}
        .sidebar-menu{list-style:none}
        .sidebar-menu li{margin:5px 0}
        .sidebar-menu a{display:flex;align-items:center;padding:15px 20px;color:rgba(255,255,255,.8);text-decoration:none;transition:.3s;border-left:3px solid transparent}
        .sidebar-menu a:hover,.sidebar-menu a.active{background:rgba(255,180,0,.1);color:#FFB400;border-left-color:#FFB400}
        .sidebar-menu a span{margin-left:10px;font-weight:500}
        .main-content{flex:1;margin-left:280px;padding:20px}
        .main-header{background:#fff;padding:20px 30px;border-radius:5px;margin-bottom:30px;box-shadow:0 2px 10px rgba(0,0,0,.1);display:flex;justify-content:space-between;align-items:center}
        .main-header h1{color:#2d3748;font-weight:600}
        .user-info{display:flex;align-items:center;gap:15px}
        .user-avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#FFB400,#e6a200);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600}
        .content-section{display:none;animation:fadeIn .5s}
        .content-section.active{display:block}
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:30px}
        .stat-card{background:#fff;padding:25px;border-radius:5px;box-shadow:0 2px 10px rgba(0,0,0,.1);border-left:4px solid #FFB400}
        .stat-number{font-size:2.5rem;font-weight:700;color:#FFB400;margin-bottom:5px}
        .stat-label{color:#666;font-weight:500}
        .table-container{background:#fff;border-radius:5px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,.1)}
        .table-header{padding:20px 25px;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center}
        .table-header h3{color:#2d3748;font-weight:600}
        .add-btn{padding:10px 20px;background:#FFB400;color:#333;border:none;border-radius:5px;cursor:pointer;font-weight:600;transition:.3s}
        .add-btn:hover{background:#e6a200}
        .data-table{width:100%;border-collapse:collapse}
        .data-table th,.data-table td{padding:15px 25px;text-align:left;border-bottom:1px solid #e2e8f0}
        .data-table th{background:#f7fafc;font-weight:600;color:#2d3748}
        .data-table tbody tr:hover{background:#f7fafc}
        .action-btn{padding:5px 10px;border:none;border-radius:3px;cursor:pointer;font-size:.8rem;margin:0 2px}
        .edit-btn{background:#4299e1;color:#fff}
        .delete-btn{background:#f56565;color:#fff}
        .toggle-btn{background:#ed8936;color:#fff}
        .hidden{opacity:.5;text-decoration:line-through}

        /* ----------  ADMIN MODAL  ---------- */
        .admin-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:2000;animation:fadeIn .3s}
        .admin-modal-content{background:#fff;margin:2% auto;padding:0;border-radius:5px;width:95%;max-width:1000px;max-height:95vh;position:relative;animation:slideIn .3s;overflow-y:auto}
        .admin-modal-header{padding:20px 25px;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:#fff;z-index:10}
        .admin-modal-header h3{color:#2d3748;font-weight:600}
        .admin-modal-close{background:none;border:none;font-size:24px;cursor:pointer;color:#666}
        .admin-modal-close:hover{color:#333}
        .admin-modal-body{padding:25px}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px}
        .form-row-full{display:grid;grid-template-columns:1fr;margin-bottom:20px}
        .form-section{background:#f8f9fa;padding:20px;border-radius:5px;margin-bottom:20px;border-left:4px solid #FFB400}
        .form-section h4{color:#2d3748;margin-bottom:15px;font-weight:600;font-size:1.1rem}
        .form-group{display:flex;flex-direction:column}
        .form-label{margin-bottom:8px;font-weight:600;color:#2d3748}
        .form-input,.form-select,.form-textarea{padding:12px 15px;border:1.5px solid rgba(255,180,0,.3);border-radius:5px;font-size:1rem;font-family:'Poppins',sans-serif;transition:.3s;background:rgba(255,255,255,.8)}
        .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:#FFB400;background:#fff;box-shadow:0 0 0 3px rgba(255,180,0,.1)}
        .form-textarea{resize:vertical}
        .btn-primary{padding:12px 24px;background:#FFB400;color:#333;border:none;border-radius:5px;cursor:pointer;font-weight:600;transition:.3s}
        .btn-primary:hover{background:#e6a200}
        .btn-secondary{padding:12px 24px;background:#e2e8f0;color:#2d3748;border:none;border-radius:5px;cursor:pointer;font-weight:600;transition:.3s}
        .btn-secondary:hover{background:#cbd5e0}
        .dynamic-fields{border:1px solid #e2e8f0;border-radius:5px;padding:15px;margin-bottom:15px}
        .field-row{display:grid;grid-template-columns:1fr 1fr auto;gap:10px;margin-bottom:10px;align-items:end}
        .btn-small{padding:8px 12px;background:#e2e8f0;color:#2d3748;border:none;border-radius:3px;cursor:pointer;font-size:.9rem}
        .btn-small:hover{background:#cbd5e0}
        .btn-add{background:#48bb78;color:#fff}
        .btn-remove{background:#f56565;color:#fff}

        /* ----------  MEDIA UPLOAD  ---------- */
        .media-upload-section{background:#f8f9fa;padding:20px;border-radius:5px;margin-bottom:20px;border-left:4px solid #FFB400}
        .upload-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-top:15px}
        .upload-item{border:2px dashed #FFB400;border-radius:5px;padding:20px;text-align:center;background:#fff;position:relative}
        .upload-input{display:none}
        .upload-label{cursor:pointer;display:block;color:#FFB400;font-weight:500}
        .upload-preview{max-width:100%;max-height:100px;margin-bottom:10px;border-radius:3px}
        .upload-remove{position:absolute;top:5px;right:5px;background:#f56565;color:#fff;border:none;border-radius:50%;width:20px;height:20px;cursor:pointer;font-size:12px}

        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        @keyframes slideIn{from{transform:translateY(-50px);opacity:0}to{transform:translateY(0);opacity:1}}
        @media(max-width:768px){.form-row{grid-template-columns:1fr}.sidebar{transform:translateX(-100%);transition:.3s}.sidebar.active{transform:translateX(0)}.main-content{margin-left:0}}
    </style>
</head>
<body>
    <!-- ----------  SIDEBAR  ---------- -->
    <nav class="sidebar">
        <div class="sidebar-header">
            <h2>Admin Panel</h2>
            <p>Advanced Commodity System</p>
        </div>
        <ul class="sidebar-menu">
            <li><a href="#" class="menu-link active" data-section="dashboard">üè† <span>Dashboard</span></a></li>
            <li><a href="#" class="menu-link" data-section="products">üì¶ <span>Products</span></a></li>
            <li><a href="#" class="menu-link" data-section="categories">üìã <span>Categories</span></a></li>
            <li><a href="#" class="menu-link" data-section="innovation">üî¨ <span>Innovation Lab</span></a></li>
            <li><a href="#" class="menu-link" data-section="inquiries">üìû <span>Inquiries</span></a></li>
            <li><a href="#" class="menu-link" data-section="contacts">‚úâÔ∏è <span>Contact Settings</span></a></li>
        </ul>
    </nav>

    <!-- ----------  MAIN CONTENT  ---------- -->
    <main class="main-content">
        <header class="main-header">
            <h1 id="pageTitle">Dashboard</h1>
            <div class="user-info">
                <div class="user-avatar">A</div>
                <span>Admin User</span>
            </div>
        </header>

        <!-- =====  DASHBOARD  ===== -->
        <section id="dashboard" class="content-section active">
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-number" id="totalProducts">0</div><div class="stat-label">Total Products</div></div>
                <div class="stat-card"><div class="stat-number" id="totalCategories">0</div><div class="stat-label">Categories</div></div>
                <div class="stat-card"><div class="stat-number" id="totalProjects">0</div><div class="stat-label">R&D Projects</div></div>
                <div class="stat-card"><div class="stat-number" id="totalInquiries">0</div><div class="stat-label">Total Inquiries</div></div>
            </div>
        </section>

        <!-- =====  PRODUCTS  ===== -->
        <section id="products" class="content-section">
            <div class="table-container">
                <div class="table-header"><h3>Advanced Product Management</h3><button class="add-btn" onclick="openProductModal()">Add Product</button></div>
                <table class="data-table"><thead><tr><th>Product Name</th><th>Category</th><th>Monthly Capacity</th><th>Price</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="productsTable"></tbody>
                </table>
            </div>
        </section>

        <!-- =====  CATEGORIES  ===== -->
        <section id="categories" class="content-section">
            <div class="table-container">
                <div class="table-header"><h3>Category Management</h3><button class="add-btn" onclick="openCategoryModal()">Add Category</button></div>
                <table class="data-table"><thead><tr><th>Category Name</th><th>Products Count</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="categoriesTable"></tbody>
                </table>
            </div>
        </section>

        <!-- =====  INNOVATION LAB  ===== -->
        <section id="innovation" class="content-section">
            <div class="table-container">
                <div class="table-header"><h3>Innovation Lab ‚Äì Research Projects</h3><button class="add-btn" onclick="openProjectModal()" id="addProjectBtn">Add Project</button></div>
                <table class="data-table"><thead><tr><th>Project Title</th><th>Phase</th><th>Expected Date</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="projectsTable"></tbody>
                </table>
            </div>
        </section>

        <!-- =====  INQUIRIES  ===== -->
        <section id="inquiries" class="content-section">
            <div class="table-container">
                <div class="table-header"><h3>Customer Inquiries</h3></div>
                <table class="data-table"><thead><tr><th>Date</th><th>Company</th><th>Contact</th><th>Interest</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="inquiriesTable"></tbody>
                </table>
            </div>
        </section>

        <!-- =====  CONTACT SETTINGS  ===== -->
        <section id="contacts" class="content-section">
            <div class="table-container">
                <div class="table-header"><h3>Contact Information Settings</h3></div>
                <div style="padding:25px">
                    <form id="contactSettingsForm" onsubmit="saveContactSettings(event)">
                        <div class="form-section"><h4>Sales & Inquiries</h4><div class="form-row">
                            <div class="form-group"><label class="form-label">Sales Email</label><input type="email" class="form-input" name="salesEmail" required></div>
                            <div class="form-group"><label class="form-label">Sales Phone</label><input type="text" class="form-input" name="salesPhone" required></div>
                        </div></div>
                        <div class="form-section"><h4>Technical Support</h4><div class="form-row">
                            <div class="form-group"><label class="form-label">Technical Email</label><input type="email" class="form-input" name="techEmail" required></div>
                            <div class="form-group"><label class="form-label">Technical Phone</label><input type="text" class="form-input" name="techPhone" required></div>
                        </div></div>
                        <div class="form-section"><h4>R&D Partnerships</h4><div class="form-row">
                            <div class="form-group"><label class="form-label">R&D Email</label><input type="email" class="form-input" name="rdEmail" required></div>
                            <div class="form-group"><label class="form-label">R&D Phone</label><input type="text" class="form-input" name="rdPhone" required></div>
                        </div></div>
                        <div class="form-section"><h4>Email Recipients for Inquiries</h4>
                            <div class="form-row-full"><div class="form-group">
                                <label class="form-label">Primary Recipient Email</label><input type="email" class="form-input" name="primaryRecipient" required>
                                <small style="color:#666">All customer inquiries will be sent to this email</small>
                            </div></div>
                            <div class="form-row">
                                <div class="form-group"><label class="form-label">CC Email 1 (Optional)</label><input type="email" class="form-input" name="ccEmail1"></div>
                                <div class="form-group"><label class="form-label">CC Email 2 (Optional)</label><input type="email" class="form-input" name="ccEmail2"></div>
                            </div>
                        </div>
                        <div style="margin-top:30px"><button type="submit" class="btn-primary">Save Contact Settings</button></div>
                    </form>
                </div>
            </div>
        </section>
    </main>

    <!-- =====  PRODUCT MODAL  ===== -->
    <div id="adminProductModal" class="admin-modal">
        <div class="admin-modal-content">
            <div class="admin-modal-header">
                <h3 id="productModalTitle">Add New Product</h3>
                <button class="admin-modal-close" onclick="closeAdminModal('adminProductModal')">&times;</button>
            </div>
            <div class="admin-modal-body">
                <form id="productForm">
                    <input type="hidden" id="productId" name="id">
                    <div class="form-section"><h4>Basic Information</h4>
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">Product Name</label><input type="text" class="form-input" name="title" required></div>
                            <div class="form-group"><label class="form-label">Category</label><select class="form-select" name="category" id="productCategory" required><option value="">Select Category</option></select></div>
                        </div>
                        <div class="form-row-full"><div class="form-group"><label class="form-label">Product Overview</label><textarea class="form-textarea" name="overview" rows="4" required></textarea></div></div>
                    </div>
                    <div class="form-section"><h4>Production Capacity & Pricing</h4>
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">Monthly Capacity</label><input type="text" class="form-input" name="monthlyCapacity" placeholder="e.g., 500 tons" required></div>
                            <div class="form-group"><label class="form-label">Annual Capacity</label><input type="text" class="form-input" name="annualCapacity" placeholder="e.g., 6,000 tons"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">Price</label><input type="text" class="form-input" name="price" placeholder="e.g., $145/tonne" required></div>
                            <div class="form-group"><label class="form-label">Lead Time</label><input type="text" class="form-input" name="leadTime" placeholder="e.g., 15-30 days"></div>
                        </div>
                    </div>
                    <div class="form-section"><h4>Technical Specifications</h4>
                        <div class="dynamic-fields" id="specificationsFields">
                            <div class="field-row"><input type="text" class="form-input" placeholder="Specification Name" name="specName[]"><input type="text" class="form-input" placeholder="Value" name="specValue[]"><button type="button" class="btn-small btn-remove" onclick="removeField(this)">Remove</button></div>
                        </div>
                        <button type="button" class="btn-small btn-add" onclick="addSpecificationField()">Add Specification</button>
                    </div>
                    <div class="form-section"><h4>Applications</h4>
                        <div class="dynamic-fields" id="applicationsFields">
                            <div class="field-row"><input type="text" class="form-input" placeholder="Application Description" name="application[]"><div></div><button type="button" class="btn-small btn-remove" onclick="removeField(this)">Remove</button></div>
                        </div>
                        <button type="button" class="btn-small btn-add" onclick="addApplicationField()">Add Application</button>
                    </div>
                    <div class="form-section"><h4>Product Images & Videos</h4>
                        <div class="upload-grid">
                            <div class="upload-item"><input type="file" class="upload-input" id="productImage" accept="image/*" onchange="handleFileUpload(this,'product-image')"><label for="productImage" class="upload-label"><div>üì∑ Product Image</div><div style="font-size:.8rem;margin-top:5px">Click to upload</div></label><div id="productImagePreview"></div></div>
                            <div class="upload-item"><input type="file" class="upload-input" id="processImage" accept="image/*" onchange="handleFileUpload(this,'process-image')"><label for="processImage" class="upload-label"><div>üè≠ Process Image</div><div style="font-size:.8rem;margin-top:5px">Click to upload</div></label><div id="processImagePreview"></div></div>
                            <div class="upload-item"><input type="file" class="upload-input" id="processVideo" accept="video/*" onchange="handleFileUpload(this,'process-video')"><label for="processVideo" class="upload-label"><div>üé• Process Video</div><div style="font-size:.8rem;margin-top:5px">Click to upload</div></label><div id="processVideoPreview"></div></div>
                            <div class="upload-item"><input type="file" class="upload-input" id="qualityCharts" accept="image/*" onchange="handleFileUpload(this,'quality-charts')"><label for="qualityCharts" class="upload-label"><div>üìä Quality Charts</div><div style="font-size:.8rem;margin-top:5px">Click to upload</div></label><div id="qualityChartsPreview"></div></div>
                        </div>
                    </div>
                    <div class="form-section"><h4>Environmental & Quality Information</h4>
                        <div class="form-row-full"><div class="form-group"><label class="form-label">Environmental Impact</label><textarea class="form-textarea" name="environmentalImpact" rows="2" placeholder="e.g., Sustainable production with zero-waste manufacturing processes"></textarea></div></div>
                        <div class="form-row-full"><div class="form-group"><label class="form-label">Quality Assurance</label><textarea class="form-textarea" name="qualityAssurance" rows="2" placeholder="e.g., Rigorous testing and quality certificates provided with each shipment"></textarea></div></div>
                    </div>
                    <div class="form-row" style="margin-top:30px"><button type="submit" class="btn-primary">Save Product</button><button type="button" class="btn-secondary" onclick="closeAdminModal('adminProductModal')">Cancel</button></div>
                </form>
            </div>
        </div>
    </div>

    <!-- =====  CATEGORY MODAL  ===== -->
    <div id="adminCategoryModal" class="admin-modal">
        <div class="admin-modal-content">
            <div class="admin-modal-header">
                <h3 id="categoryModalTitle">Add New Category</h3>
                <button class="admin-modal-close" onclick="closeAdminModal('adminCategoryModal')">&times;</button>
            </div>
            <div class="admin-modal-body">
                <form id="categoryForm">
                    <input type="hidden" id="categoryId" name="id">
                    <div class="form-group"><label class="form-label">Category Name</label><input type="text" class="form-input" name="name" required></div>
                    <div class="form-group"><label class="form-label">Description</label><textarea class="form-textarea" name="description" rows="4" required></textarea></div>
                    <div class="form-group" style="display:flex;gap:15px;margin-top:30px"><button type="submit" class="btn-primary">Save Category</button><button type="button" class="btn-secondary" onclick="closeAdminModal('adminCategoryModal')">Cancel</button></div>
                </form>
            </div>
        </div>
    </div>

    <!-- =====  PROJECT MODAL  ===== -->
    <div id="adminProjectModal" class="admin-modal">
        <div class="admin-modal-content">
            <div class="admin-modal-header">
                <h3 id="projectModalTitle">Add New Project</h3>
                <button class="admin-modal-close" onclick="closeAdminModal('adminProjectModal')">&times;</button>
            </div>
            <div class="admin-modal-body">
                <form id="projectForm">
                    <input type="hidden" id="projectId" name="id">
                    <div class="form-group"><label class="form-label">Project Title</label><input type="text" class="form-input" name="title" required></div>
                    <div class="form-group"><label class="form-label">Phase</label><select class="form-select" name="phase" required><option value="">Select Phase</option><option value="Manufacturing phase">Manufacturing phase</option><option value="Pilot testing">Pilot testing</option><option value="Research phase">Research phase</option></select></div>
                    <div class="form-group"><label class="form-label">Expected Date</label><input type="text" class="form-input" name="expectedDate" placeholder="e.g., Q2 2026" required></div>
                    <div class="form-group" style="display:flex;gap:15px;margin-top:30px"><button type="submit" class="btn-primary">Save Project</button><button type="button" class="btn-secondary" onclick="closeAdminModal('adminProjectModal')">Cancel</button></div>
                </form>
            </div>
        </div>
    </div>

    <!-- ==================  JAVASCRIPT  ================== -->
    <script>
        /* ==========  SUPABASE CLIENT  ========== */
        const SUPABASE_URL  = 'https://kunrarieegagtkxiudfa.supabase.co';
        const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt1bnJhcmllZWdhZ3RreGl1ZGZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1MTIyMjgsImV4cCI6MjA3NTA4ODIyOH0.cAcKViNIT6qI5eFM18IDaWKWsAIfwQ3gvugFo0iWbaI';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

        /* ==========  GLOBAL STATE  ========== */
        let products   = {};
        let categories = {};
        let projects   = {};
        let inquiries  = [];
        let contactCfg = {};

        /* ==========  INITIAL LOAD  ========== */
        window.addEventListener('DOMContentLoaded', () => {
            loadAllTables();
            attachMenuListeners();
        });

        /* ==========  ATTACH SIDEBAR MENU  ========== */
        function attachMenuListeners() {
            document.querySelectorAll('.menu-link').forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    document.querySelectorAll('.menu-link').forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                    const section = link.dataset.section;
                    document.getElementById(section).classList.add('active');
                    document.getElementById('pageTitle').textContent = link.querySelector('span').textContent;
                    if (section === 'contacts') populateContactForm();
                });
            });
        }

        /* ==========  LOAD ALL TABLES  ========== */
        async function loadAllTables() {
            const { data: p } = await supabase.from('products').select('*');
            const { data: c } = await supabase.from('categories').select('*');
            const { data: r } = await supabase.from('projects').select('*');
            const { data: i } = await supabase.from('inquiries').select('*');
            const { data: cfg } = await supabase.from('contact_settings').select('*').single();

            products   = Object.fromEntries((p || []).map(x => [x.id, x]));
            categories = Object.fromEntries((c || []).map(x => [x.id, x]));
            projects   = Object.fromEntries((r || []).map(x => [x.id, x]));
            inquiries  = i || [];
            contactCfg = cfg || {
                salesEmail: 'sales@commoditytrading.com', salesPhone: '+91-11-2345-6789',
                techEmail: 'technical@commoditytrading.com', techPhone: '+91-11-2345-6790',
                rdEmail: 'innovation@commoditytrading.com', rdPhone: '+91-11-2345-6791',
                primaryRecipient: 'admin@commoditytrading.com', ccEmail1: '', ccEmail2: ''
            };

            renderDashboard();
            renderProductsTable();
            renderCategoriesTable();
            renderProjectsTable();
            renderInquiriesTable();
            populateCategorySelects();
        }

        /* ==========  RENDER TABLES  ========== */
        function renderDashboard() {
            document.getElementById('totalProducts').textContent   = Object.keys(products).length;
            document.getElementById('totalCategories').textContent = Object.keys(categories).length;
            document.getElementById('totalProjects').textContent   = Object.keys(projects).length;
            document.getElementById('totalInquiries').textContent  = inquiries.length;
        }

        function renderProductsTable() {
            const tbody = document.getElementById('productsTable');
            tbody.innerHTML = '';
            Object.values(products).forEach(pr => {
                const catName = categories[pr.category]?.name || '‚Äî';
                const tr = document.createElement('tr');
                if (!pr.visible) tr.classList.add('hidden');
                tr.innerHTML = `
                    <td>${pr.title}</td>
                    <td>${catName}</td>
                    <td>${pr.capacity?.['Monthly Capacity'] || '‚Äî'}</td>
                    <td>${pr.capacity?.['Price'] || '‚Äî'}</td>
                    <td>${pr.visible ? 'Visible' : 'Hidden'}</td>
                    <td>
                        <button class="action-btn edit-btn" onclick="editProduct('${pr.id}')">Edit</button>
                        <button class="action-btn toggle-btn" onclick="toggleProductVisibility('${pr.id}')">${pr.visible ? 'Hide' : 'Show'}</button>
                        <button class="action-btn delete-btn" onclick="deleteProduct('${pr.id}')">Delete</button>
                    </td>`;
                tbody.appendChild(tr);
            });
        }

        function renderCategoriesTable() {
            const tbody = document.getElementById('categoriesTable');
            tbody.innerHTML = '';
            Object.values(categories).forEach(cat => {
                const count = Object.values(products).filter(p => p.category === cat.id).length;
                const tr = document.createElement('tr');
                if (!cat.visible) tr.classList.add('hidden');
                tr.innerHTML = `
                    <td>${cat.name}</td>
                    <td>${count}</td>
                    <td>${cat.visible ? 'Visible' : 'Hidden'}</td>
                    <td>
                        <button class="action-btn edit-btn" onclick="editCategory('${cat.id}')">Edit</button>
                        <button class="action-btn toggle-btn" onclick="toggleCategoryVisibility('${cat.id}')">${cat.visible ? 'Hide' : 'Show'}</button>
                        <button class="action-btn delete-btn" onclick="deleteCategory('${cat.id}')">Delete</button>
                    </td>`;
                tbody.appendChild(tr);
            });
        }

        function renderProjectsTable() {
            const tbody = document.getElementById('projectsTable');
            tbody.innerHTML = '';
            document.getElementById('addProjectBtn').style.display = Object.keys(projects).length >= 3 ? 'none' : 'inline-block';
            Object.values(projects).forEach(proj => {
                const tr = document.createElement('tr');
                if (!proj.visible) tr.classList.add('hidden');
                tr.innerHTML = `
                    <td>${proj.title}</td>
                    <td><span class="project-phase ${proj.phase.toLowerCase().replace(' ','-')}">${proj.phase}</span></td>
                    <td>${proj.expectedDate}</td>
                    <td>${proj.visible ? 'Visible' : 'Hidden'}</td>
                    <td>
                        <button class="action-btn edit-btn" onclick="editProject('${proj.id}')">Edit</button>
                        <button class="action-btn toggle-btn" onclick="toggleProjectVisibility('${proj.id}')">${proj.visible ? 'Hide' : 'Show'}</button>
                        <button class="action-btn delete-btn" onclick="deleteProject('${proj.id}')">Delete</button>
                    </td>`;
                tbody.appendChild(tr);
            });
        }

        function renderInquiriesTable() {
            const tbody = document.getElementById('inquiriesTable');
            tbody.innerHTML = '';
            inquiries.forEach((inq, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${new Date(inq.date).toLocaleDateString()}</td>
                    <td>${inq.company || '‚Äî'}</td>
                    <td>${inq.contact || '‚Äî'}</td>
                    <td>${inq.interest || '‚Äî'}</td>
                    <td>${inq.status}</td>
                    <td>
                        <button class="action-btn view-btn" onclick="viewInquiry(${idx})">View</button>
                    </td>`;
                tbody.appendChild(tr);
            });
        }

        /* ==========  CATEGORY SELECTS (PRODUCT MODAL)  ========== */
        function populateCategorySelects() {
            const pc = document.getElementById('productCategory');
            pc.innerHTML = '<option value="">Select Category</option>';
            Object.values(categories).forEach(c => {
                pc.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            });
        }

        /* ==========  PRODUCT CRUD  ========== */
        window.openProductModal = () => {
            document.getElementById('productModalTitle').textContent = 'Add New Product';
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            ['productImage','processImage','processVideo','qualityCharts'].forEach(id => {
                document.getElementById(id).value = '';
                document.getElementById(id+'Preview').innerHTML = '';
            });
            document.getElementById('specificationsFields').innerHTML = `
                <div class="field-row">
                    <input type="text" class="form-input" placeholder="Specification Name" name="specName[]">
                    <input type="text" class="form-input" placeholder="Value" name="specValue[]">
                    <button type="button" class="btn-small btn-remove" onclick="removeField(this)">Remove</button>
                </div>`;
            document.getElementById('applicationsFields').innerHTML = `
                <div class="field-row">
                    <input type="text" class="form-input" placeholder="Application Description" name="application[]">
                    <div></div>
                    <button type="button" class="btn-small btn-remove" onclick="removeField(this)">Remove</button>
                </div>`;
            document.getElementById('adminProductModal').style.display = 'block';
        };

        window.editProduct = (id) => {
            const p = products[id];
            if (!p) return;
            document.getElementById('productModalTitle').textContent = 'Edit Product';
            document.getElementById('productId').value = id;
            ['title','category','overview','monthlyCapacity','annualCapacity','price','leadTime','environmentalImpact','qualityAssurance'].forEach(f => {
                const el = document.querySelector(`#productForm [name="${f}"]`);
                if (el) el.value = p[f] || '';
            });
            /* specs */
            const specDiv = document.getElementById('specificationsFields');
            specDiv.innerHTML = '';
            Object.entries(p.specifications || {}).forEach(([k,v]) => {
                specDiv.innerHTML += `
                    <div class="field-row">
                        <input type="text" class="form-input" placeholder="Specification Name" name="specName[]" value="${k}">
                        <input type="text" class="form-input" placeholder="Value" name="specValue[]" value="${v}">
                        <button type="button" class="btn-small btn-remove" onclick="removeField(this)">Remove</button>
                    </div>`;
            });
            /* apps */
            const appDiv = document.getElementById('applicationsFields');
            appDiv.innerHTML = '';
            (p.applications || []).forEach(app => {
                appDiv.innerHTML += `
                    <div class="field-row">
                        <input type="text" class="form-input" placeholder="Application Description" name="application[]" value="${app}">
                        <div></div>
                        <button type="button" class="btn-small btn-remove" onclick="removeField(this)">Remove</button>
                    </div>`;
            });
            /* media */
            if (p.media) {
                Object.entries(p.media).forEach(([type, src]) => {
                    const inputId = type.replace('-','') + (type.includes('image') ? 'Image' : type.includes('video') ? 'Video' : 'Charts');
                    const preview = document.getElementById(inputId + 'Preview');
                    if (preview) {
                        preview.innerHTML = type.includes('video')
                            ? `<video src="${src}" class="upload-preview" controls></video><button type="button" class="upload-remove" onclick="removeMedia('${inputId}')">&times;</button>`
                            : `<img src="${src}" class="upload-preview" alt="Preview"><button type="button" class="upload-remove" onclick="removeMedia('${inputId}')">&times;</button>`;
                        document.getElementById(inputId).dataset.fileData = src;
                    }
                });
            }
            document.getElementById('adminProductModal').style.display = 'block';
        };

        /* ----------  PRODUCT FORM SUBMIT  ---------- */
        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const id = fd.get('id') || generateId();
            const specs = {}, apps = [];
            /* collect specs */
            const specNames = fd.getAll('specName[]'), specVals = fd.getAll('specValue[]');
            specNames.forEach((n, i) => { if (n.trim() && specVals[i].trim()) specs[n.trim()] = specVals[i].trim(); });
            /* collect apps */
            fd.getAll('application[]').forEach(a => { if (a.trim()) apps.push(a.trim()); });
            /* collect media */
            const media = {};
            ['productImage','processImage','processVideo','qualityCharts'].forEach(inputId => {
                const inp = document.getElementById(inputId);
                if (inp.dataset.fileData) {
                    const type = inputId.replace('Image','-image').replace('Video','-video').replace('Charts','-charts');
                    media[type] = inp.dataset.fileData;
                }
            });
            const payload = {
                id,
                title: fd.get('title'),
                category: fd.get('category'),
                overview: fd.get('overview'),
                specifications: specs,
                applications: apps,
                capacity: {
                    'Monthly Capacity': fd.get('monthlyCapacity'),
                    'Annual Capacity': fd.get('annualCapacity'),
                    'Price': fd.get('price'),
                    'Lead Time': fd.get('leadTime')
                },
                media,
                environmentalImpact: fd.get('environmentalImpact'),
                qualityAssurance: fd.get('qualityAssurance'),
                visible: true
            };
            if (fd.get('id')) { /* update */
                await supabase.from('products').update(payload).eq('id', id);
            } else { /* insert */
                await supabase.from('products').insert([payload]);
            }
            closeAdminModal('adminProductModal');
            loadAllTables(); /* refresh */
            alert('Product saved!');
        });

        /* ----------  TOGGLE / DELETE  ---------- */
        window.toggleProductVisibility = async (id) => {
            const v = !products[id].visible;
            await supabase.from('products').update({ visible: v }).eq('id', id);
            loadAllTables();
        };
        window.deleteProduct = async (id) => {
            if (!confirm('Delete this product?')) return;
            await supabase.from('products').delete().eq('id', id);
            loadAllTables();
        };

        /* ==========  CATEGORY CRUD  ========== */
        window.openCategoryModal = () => {
            document.getElementById('categoryModalTitle').textContent = 'Add New Category';
            document.getElementById('categoryForm').reset();
            document.getElementById('categoryId').value = '';
            document.getElementById('adminCategoryModal').style.display = 'block';
        };
        window.editCategory = (id) => {
            const c = categories[id];
            document.getElementById('categoryModalTitle').textContent = 'Edit Category';
            document.getElementById('categoryId').value = id;
            document.querySelector('#categoryForm [name="name"]').value = c.name;
            document.querySelector('#categoryForm [name="description"]').value = c.description;
            document.getElementById('adminCategoryModal').style.display = 'block';
        };
        document.getElementById('categoryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const id = fd.get('id') || generateId();
            const payload = { id, name: fd.get('name'), description: fd.get('description'), visible: true };
            if (fd.get('id')) await supabase.from('categories').update(payload).eq('id', id);
            else await supabase.from('categories').insert([payload]);
            closeAdminModal('adminCategoryModal');
            loadAllTables();
            alert('Category saved!');
        });
        window.toggleCategoryVisibility = async (id) => {
            await supabase.from('categories').update({ visible: !categories[id].visible }).eq('id', id);
            loadAllTables();
        };
        window.deleteCategory = async (id) => {
            if (!confirm('Delete this category?')) return;
            await supabase.from('categories').delete().eq('id', id);
            loadAllTables();
        };

        /* ==========  PROJECT CRUD  ========== */
        window.openProjectModal = () => {
            if (Object.keys(projects).length >= 3) return alert('Max 3 projects allowed');
            document.getElementById('projectModalTitle').textContent = 'Add New Project';
            document.getElementById('projectForm').reset();
            document.getElementById('projectId').value = '';
            document.getElementById('adminProjectModal').style.display = 'block';
        };
        window.editProject = (id) => {
            const p = projects[id];
            document.getElementById('projectModalTitle').textContent = 'Edit Project';
            document.getElementById('projectId').value = id;
            document.querySelector('#projectForm [name="title"]').value = p.title;
            document.querySelector('#projectForm [name="phase"]').value = p.phase;
            document.querySelector('#projectForm [name="expectedDate"]').value = p.expectedDate;
            document.getElementById('adminProjectModal').style.display = 'block';
        };
        document.getElementById('projectForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const id = fd.get('id') || generateId();
            const payload = { id, title: fd.get('title'), phase: fd.get('phase'), expectedDate: fd.get('expectedDate'), visible: true };
            if (fd.get('id')) await supabase.from('projects').update(payload).eq('id', id);
            else await supabase.from('projects').insert([payload]);
            closeAdminModal('adminProjectModal');
            loadAllTables();
            alert('Project saved!');
        });
        window.toggleProjectVisibility = async (id) => {
            await supabase.from('projects').update({ visible: !projects[id].visible }).eq('id', id);
            loadAllTables();
        };
        window.deleteProject = async (id) => {
            if (!confirm('Delete this project?')) return;
            await supabase.from('projects').delete().eq('id', id);
            loadAllTables();
        };

        /* ==========  CONTACT SETTINGS  ========== */
        function populateContactForm() {
            Object.keys(contactCfg).forEach(k => {
                const el = document.querySelector(`#contactSettingsForm [name="${k}"]`);
                if (el) el.value = contactCfg[k] || '';
            });
        }
        window.saveContactSettings = async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const payload = {};
            for (const [k, v] of fd.entries()) payload[k] = v;
            await supabase.from('contact_settings').upsert([payload]);
            contactCfg = payload;
            alert('Contact settings saved!');
        };

        /* ==========  INQUIRY VIEW  ========== */
        window.viewInquiry = (idx) => {
            const inq = inquiries[idx];
            alert(`Inquiry Details\n\nCompany: ${inq.company}\nContact: ${inq.contact}\nEmail: ${inq.email}\nInterest: ${inq.interest}\nMessage: ${inq.message}\n\nRecipients:\nPrimary: ${inq.recipients?.primary}\nCC: ${(inq.recipients?.cc || []).join(', ')}`);
        };

        /* ==========  HELPERS  ========== */
        function generateId() { return 'id_' + Date.now() + '_' + Math.random().toString(36).slice(2, 9); }
        window.removeField = (btn) => btn.parentElement.remove();
        window.addSpecificationField = () => {
            document.getElementById('specificationsFields').insertAdjacentHTML('beforeend', `
                <div class="field-row">
                    <input type="text" class="form-input" placeholder="Specification Name" name="specName[]">
                    <input type="text" class="form-input" placeholder="Value" name="specValue[]">
                    <button type="button" class="btn-small btn-remove" onclick="removeField(this)">Remove</button>
                </div>`);
        };
        window.addApplicationField = () => {
            document.getElementById('applicationsFields').insertAdjacentHTML('beforeend', `
                <div class="field-row">
                    <input type="text" class="form-input" placeholder="Application Description" name="application[]">
                    <div></div>
                    <button type="button" class="btn-small btn-remove" onclick="removeField(this)">Remove</button>
                </div>`);
        };
        window.closeAdminModal = (id) => document.getElementById(id).style.display = 'none';
        window.onclick = (e) => { if (e.target.classList.contains('admin-modal')) e.target.style.display = 'none'; };

        /* ==========  MEDIA HANDLING  ========== */
        window.handleFileUpload = (inp, type) => {
            const file = inp.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                const preview = document.getElementById(inp.id + 'Preview');
                preview.innerHTML = (file.type.startsWith('image') ? `<img src="${reader.result}" class="upload-preview">` : `<video src="${reader.result}" class="upload-preview" controls></video>`) + `<button type="button" class="upload-remove" onclick="removeMedia('${inp.id}')">&times;</button>`;
                inp.dataset.fileData = reader.result;
            };
            reader.readAsDataURL(file);
        };
        window.removeMedia = (inpId) => {
            const inp = document.getElementById(inpId);
            inp.value = ''; inp.dataset.fileData = '';
            document.getElementById(inpId + 'Preview').innerHTML = '';
        };
    </script>
</body>
</html>
