<!-- ==========  SUPABASE  ========== -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ----------  CONFIG  ---------- */
const SUPABASE_URL  = 'https://kunrarieegagtkxiudfa.supabase.co';
const SUPABASE_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt1bnJhcmllZWdhZ3RreGl1ZGZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1MTIyMjgsImV4cCI6MjA3NTA4ODIyOH0.cAcKViNIT6qI5eFM18IDaWKWsAIfwQ3gvugFo0iWbaI';
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ----------  DATA MANAGER  ---------- */
class AdvancedDataManager{
  constructor(){ this.pull(); }

  /*  INITIAL LOAD  */
  async pull(){
    const [p,c,r,i,ct] = await Promise.all([
      supabaseClient.from('products').select('*').then(r=>r.data||[]),
      supabaseClient.from('categories').select('*').then(r=>r.data||[]),
      supabaseClient.from('projects').select('*').then(r=>r.data||[]),
      supabaseClient.from('inquiries').select('*').then(r=>r.data||[]),
      supabaseClient.from('contact_settings').select('*').single().then(r=>r.data)
    ]);
    this.products   = Object.fromEntries(p.map(x=>[x.id,x]));
    this.categories = Object.fromEntries(c.map(x=>[x.id,x]));
    this.projects   = Object.fromEntries(r.map(x=>[x.id,x]));
    this.inquiries  = i;
    this.contactSettings = ct || this.defaultContact();
    this.afterPull();
  }

  defaultContact(){
    return {
      salesEmail:'sales@commoditytrading.com', salesPhone:'+91-11-2345-6789',
      techEmail:'technical@commoditytrading.com', techPhone:'+91-11-2345-6790',
      rdEmail:'innovation@commoditytrading.com', rdPhone:'+91-11-2345-6791',
      primaryRecipient:'admin@commoditytrading.com', ccEmail1:'', ccEmail2:''
    };
  }

  afterPull(){
    this.updateStats(); this.renderFrontend(); this.renderAdmin(); this.loadContactSettings();
  }

  /*  STATS  */
  updateStats(){
    ['totalProducts','totalCategories','totalProjects','totalInquiries']
      .forEach((id,idx)=>document.getElementById(id).textContent=
        [Object.keys(this.products),Object.keys(this.categories),Object.keys(this.projects),this.inquiries][idx].length);
  }

  /*  FRONTEND  */
  getVisible(obj){ return Object.values(obj).filter(x=>x.visible!==false); }
  getProductsByCategory(cat){ return this.getVisible(this.products).filter(p=>p.category===cat); }

  renderFrontend(){
    this.renderProducts(); this.renderFilters(); this.renderProjects();
    this.loadContactCategoryOptions(); this.loadQuoteCategoryOptions(); this.updateContactInfo();
  }
  renderProducts(){
    const grid=document.getElementById('productsGrid'); grid.innerHTML='';
    this.getVisible(this.categories).forEach(cat=>{
      const prods=this.getProductsByCategory(cat.id); if(!prods.length)return;
      const card=document.createElement('div'); card.className='category-card'; card.dataset.category=cat.id;
      card.onclick=()=>openCategory(cat.id);
      card.innerHTML=`
        <div class="category-header"><h3 class="category-title">${cat.name}</h3><span class="product-count">${prods.length} products</span></div>
        <p>${cat.description}</p>
        <ul class="product-list">${prods.map(p=>`
          <li class="product-item" onclick="event.stopPropagation(); openProductModal('${p.id}')">
            <div class="product-name">${p.title}</div><div class="product-capacity">Capacity: ${p.capacity?.['Monthly Capacity']||'N/A'}</div>
          </li>`).join('')}</ul>`;
      grid.appendChild(card);
    });
  }
  renderFilters(){
    const cont=document.getElementById('categoryFilters');
    cont.innerHTML=`<button class="filter-btn active" onclick="filterCategory('all')">All Categories</button>`+
      this.getVisible(this.categories).map(c=>`<button class="filter-btn" onclick="filterCategory('${c.id}')">${c.name}</button>`).join('');
  }
  renderProjects(){
    const cont=document.getElementById('researchProjectsContainer');
    cont.innerHTML=this.getVisible(this.projects).map(p=>`
      <div class="project-card"><h4 class="project-name">${p.title}</h4>
      <div class="project-phase ${p.phase.toLowerCase().replace(' ','-')}">${p.phase}</div>
      <div class="project-expected">Expected: ${p.expectedDate}</div></div>`).join('');
  }
  loadContactCategoryOptions(){
    const sel=document.querySelector('.contact-form select[name="interest"]');
    sel.innerHTML='<option value="">Select Category</option>'+
      this.getVisible(this.categories).map(c=>`<option value="${c.id}">${c.name}</option>`).join('')+
      '<option value="custom">Custom Development</option>';
  }
  loadQuoteCategoryOptions(){
    const sel=document.querySelector('#quoteForm select[name="material"]');
    sel.innerHTML='<option value="">Select Material</option>'+
      this.getVisible(this.categories).map(cat=>`<optgroup label="${cat.name}">`+
        this.getProductsByCategory(cat.id).map(p=>`<option value="${p.id}">${p.title}</option>`).join('')+
      `</optgroup>`).join('')+
      '<option value="Custom Material Development">Custom Material Development</option><option value="Pilot Program">Pilot Program</option>';
  }
  updateContactInfo(){
    ['sales','tech','rd'].forEach(d=>{
      document.getElementById(d+'Email').textContent=this.contactSettings[d+'Email']||'';
      document.getElementById(d+'Phone').textContent=this.contactSettings[d+'Phone']||'';
    });
  }
  loadContactSettings(){
    const form=document.getElementById('contactSettingsForm');
    if(!form)return;
    Object.keys(this.contactSettings).forEach(k=>{ if(form[k])form[k].value=this.contactSettings[k]||''; });
  }

  /*  ADMIN  */
  renderAdmin(){
    this.renderProductsAdmin(); this.renderCategoriesAdmin(); this.renderProjectsAdmin(); this.renderInquiriesAdmin(); this.loadCategoryOptions();
  }
  renderProductsAdmin(){
    const tb=document.getElementById('productsTable'); tb.innerHTML='';
    Object.values(this.products).forEach(pr=>{
      const cat=this.categories[pr.category]; const tr=document.createElement('tr'); if(!pr.visible)tr.classList.add('hidden');
      tr.innerHTML=`<td>${pr.title}</td><td>${cat?cat.name:'—'}</td><td>${pr.capacity?.['Monthly Capacity']||'—'}</td>
        <td>${pr.capacity?.Price||'—'}</td><td>${pr.visible?'Visible':'Hidden'}</td>
        <td><button class="action-btn edit-btn" onclick="editProduct('${pr.id}')">Edit</button>
            <button class="action-btn toggle-btn" onclick="dataManager.toggleProductVisibility('${pr.id}')">${pr.visible?'Hide':'Show'}</button>
            <button class="action-btn delete-btn" onclick="dataManager.deleteProduct('${pr.id}')">Delete</button></td>`;
      tb.appendChild(tr);
    });
  }
  renderCategoriesAdmin(){
    const tb=document.getElementById('categoriesTable'); tb.innerHTML='';
    Object.values(this.categories).forEach(cat=>{
      const cnt=this.getProductsByCategory(cat.id).length; const tr=document.createElement('tr'); if(!cat.visible)tr.classList.add('hidden');
      tr.innerHTML=`<td>${cat.name}</td><td>${cnt}</td><td>${cat.visible?'Visible':'Hidden'}</td>
        <td><button class="action-btn edit-btn" onclick="editCategory('${cat.id}')">Edit</button>
            <button class="action-btn toggle-btn" onclick="dataManager.toggleCategoryVisibility('${cat.id}')">${cat.visible?'Hide':'Show'}</button>
            <button class="action-btn delete-btn" onclick="dataManager.deleteCategory('${cat.id}')">Delete</button></td>`;
      tb.appendChild(tr);
    });
  }
  renderProjectsAdmin(){
    const tb=document.getElementById('projectsTable'),btn=document.getElementById('addProjectBtn');
    btn.style.display=Object.keys(this.projects).length>=3?'none':'inline-block';
    tb.innerHTML='';
    Object.values(this.projects).forEach(p=>{
      const tr=document.createElement('tr'); if(!p.visible)tr.classList.add('hidden');
      tr.innerHTML=`<td>${p.title}</td><td><span class="project-phase ${p.phase.toLowerCase().replace(' ','-')}">${p.phase}</span></td>
        <td>${p.expectedDate}</td><td>${p.visible?'Visible':'Hidden'}</td>
        <td><button class="action-btn edit-btn" onclick="editProject('${p.id}')">Edit</button>
            <button class="action-btn toggle-btn" onclick="dataManager.toggleProjectVisibility('${p.id}')">${p.visible?'Hide':'Show'}</button>
            <button class="action-btn delete-btn" onclick="dataManager.deleteProject('${p.id}')">Delete</button></td>`;
      tb.appendChild(tr);
    });
  }
  renderInquiriesAdmin(){
    const tb=document.getElementById('inquiriesTable'); tb.innerHTML='';
    this.inquiries.forEach((q,i)=>{
      const tr=document.createElement('tr'),d=new Date(q.date).toLocaleDateString();
      tr.innerHTML=`<td>${d}</td><td>${q.company||'—'}</td><td>${q.contact||'—'}</td>
        <td>${q.interest||'—'}</td><td>${q.status}</td>
        <td><button class="action-btn view-btn" onclick="viewInquiry(${i})">View</button>
            <button class="action-btn edit-btn" onclick="editInquiryEmail(${i})">Edit Email</button></td>`;
      tb.appendChild(tr);
    });
  }
  loadCategoryOptions(){
    const sel=document.getElementById('productCategory'); if(!sel)return;
    sel.innerHTML='<option value="">Select Category</option>'+
      Object.values(this.categories).map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
  }

  /*  CRUD –– all talk to Supabase  */
  async addProduct(d){
    const id=d.id||self.crypto.randomUUID(),specs={},apps=[];
    if(d.specName&&d.specValue)d.specName.forEach((n,i)=>{if(n&&d.specValue[i])specs[n]=d.specValue[i];});
    if(d.application)d.application.forEach(a=>{if(a.trim())apps.push(a.trim());});
    const payload={id,title:d.title,category:d.category,overview:d.overview,specifications:specs,applications:apps,
      capacity:{'Monthly Capacity':d.monthlyCapacity,'Annual Capacity':d.annualCapacity||'','Price':d.price,'Lead Time':d.leadTime||''},
      media:d.media||{},environmentalImpact:d.environmentalImpact||'',qualityAssurance:d.qualityAssurance||'',visible:true};
    await supabaseClient.from('products').insert([payload]);
    this.products[id]=payload; this.afterPull();
  }
  async editProduct(id,d){
    if(!this.products[id])return;
    const specs={},apps=[];
    if(d.specName&&d.specValue)d.specName.forEach((n,i)=>{if(n&&d.specValue[i])specs[n]=d.specValue[i];});
    if(d.application)d.application.forEach(a=>{if(a.trim())apps.push(a.trim());});
    const payload={...this.products[id],title:d.title,category:d.category,overview:d.overview,specifications:specs,applications:apps,
      capacity:{'Monthly Capacity':d.monthlyCapacity,'Annual Capacity':d.annualCapacity||'','Price':d.price,'Lead Time':d.leadTime||''},
      media:d.media||this.products[id].media||{},environmentalImpact:d.environmentalImpact||'',qualityAssurance:d.qualityAssurance||''};
    await supabaseClient.from('products').update(payload).eq('id',id);
    this.products[id]=payload; this.afterPull();
  }
  async deleteProduct(id){if(!confirm('Delete product?'))return; await supabaseClient.from('products').delete().eq('id',id); delete this.products[id]; this.afterPull();}
  async toggleProductVisibility(id){
    this.products[id].visible=!this.products[id].visible;
    await supabaseClient.from('products').update({visible:this.products[id].visible}).eq('id',id);
    this.afterPull();
  }

  async addCategory(d){
    const id=d.id||self.crypto.randomUUID(),payload={id,name:d.name,description:d.description,visible:true};
    await supabaseClient.from('categories').insert([payload]);
    this.categories[id]=payload; this.afterPull();
  }
  async editCategory(id,d){
    const payload={...this.categories[id],name:d.name,description:d.description};
    await supabaseClient.from('categories').update(payload).eq('id',id);
    this.categories[id]=payload; this.afterPull();
  }
  async deleteCategory(id){if(!confirm('Delete category?'))return; await supabaseClient.from('categories').delete().eq('id',id); delete this.categories[id]; this.afterPull();}
  async toggleCategoryVisibility(id){
    this.categories[id].visible=!this.categories[id].visible;
    await supabaseClient.from('categories').update({visible:this.categories[id].visible}).eq('id',id);
    this.afterPull();
  }

  async addProject(d){
    if(Object.keys(this.projects).length>=3){alert('Max 3 projects');return;}
    const id=d.id||self.crypto.randomUUID(),payload={id,title:d.title,phase:d.phase,expectedDate:d.expectedDate,visible:true};
    await supabaseClient.from('projects').insert([payload]);
    this.projects[id]=payload; this.afterPull();
  }
  async editProject(id,d){
    const payload={...this.projects[id],title:d.title,phase:d.phase,expectedDate:d.expectedDate};
    await supabaseClient.from('projects').update(payload).eq('id',id);
    this.projects[id]=payload; this.afterPull();
  }
  async deleteProject(id){if(!confirm('Delete project?'))return; await supabaseClient.from('projects').delete().eq('id',id); delete this.projects[id]; this.afterPull();}
  async toggleProjectVisibility(id){
    this.projects[id].visible=!this.projects[id].visible;
    await supabaseClient.from('projects').update({visible:this.projects[id].visible}).eq('id',id);
    this.afterPull();
  }

  async addInquiry(d){
    const payload={id:self.crypto.randomUUID(),company:d.company,contact:d.contact,email:d.email,interest:d.interest,message:d.message,
      material:d.material||'',volume:d.volume||'',timeline:d.timeline||'',requirements:d.requirements||'',
      date:new Date().toISOString(),status:'New',
      recipients:{primary:this.contactSettings.primaryRecipient,cc:[this.contactSettings.ccEmail1,this.contactSettings.ccEmail2].filter(Boolean)}};
    await supabaseClient.from('inquiries').insert([payload]);
    this.inquiries.push(payload); this.afterPull();
  }
  async saveContactSettings(s){
    this.contactSettings={...s};
    await supabaseClient.from('contact_settings').upsert([this.contactSettings]);
    this.afterPull();
  }
}

/* ----------  GLOBALS  ---------- */
const dataManager=new AdvancedDataManager();
let currentMode='frontend';

/* ----------  MODE TOGGLE  ---------- */
function toggleMode(){
  const f=document.getElementById('frontendView'),a=document.getElementById('adminView'),b=document.getElementById('modeToggle');
  if(currentMode==='frontend'){f.classList.remove('active');a.classList.add('active');b.textContent='Switch to Frontend';currentMode='admin';}
  else{a.classList.remove('active');f.classList.add('active');b.textContent='Switch to Admin';currentMode='frontend';}
}

/* ----------  EXISTING UI WRAPPERS (unchanged behaviour)  ---------- */
function openProductModal(pid){ /* …your existing code… */ }
function closeModal(mid){document.getElementById(mid).style.display='none';}
function openCategory(cat){console.log('open',cat);}
function searchProducts(){ /* …your existing code… */ }
function filterCategory(cat){ /* …your existing code… */ }
function openQuoteModal(s){ /* …your existing code… */ }
function closeQuoteModal(){document.getElementById('quoteModal').style.display='none';}
function submitQuoteForm(e){e.preventDefault();const f=new FormData(e.target),d=Object.fromEntries(f);d.interest='Quote Request';dataManager.addInquiry(d);alert('Quote sent');e.target.reset();closeQuoteModal();}
function submitForm(e){e.preventDefault();const f=new FormData(e.target),d=Object.fromEntries(f);dataManager.addInquiry(d);alert('Message sent');e.target.reset();}

/* ----------  ADMIN MODALS  ---------- */
function openProductModal(){ /* …your existing code… */ }
function editProduct(id){ /* …your existing code… */ }
function openCategoryModal(){ /* …your existing code… */ }
function editCategory(id){ /* …your existing code… */ }
function openProjectModal(){ /* …your existing code… */ }
function editProject(id){ /* …your existing code… */ }
function editInquiryEmail(i){ /* …your existing code… */ }
function closeAdminModal(mid){document.getElementById(mid).style.display='none';}
function viewInquiry(i){alert(JSON.stringify(dataManager.inquiries[i],null,2));}
function saveContactSettings(e){e.preventDefault();const f=new FormData(e.target),s=Object.fromEntries(f);dataManager.saveContactSettings(s);alert('Saved');}

/* ----------  FORM HANDLERS (unchanged)  ---------- */
document.getElementById('productForm').onsubmit=async(e)=>{
  e.preventDefault();const f=new FormData(e.target),d=Object.fromEntries(f);
  d.media={};['productImage','processImage','processVideo','qualityCharts'].forEach(id=>{
    const inp=document.getElementById(id);if(inp.dataset.fileData)d.media[id.replace('Image','-image').replace('Video','-video').replace('Charts','-charts')]=inp.dataset.fileData;
  });
  d.specName=[...e.target.querySelectorAll('[name="specName[]"]')].map(x=>x.value);
  d.specValue=[...e.target.querySelectorAll('[name="specValue[]"]')].map(x=>x.value);
  d.application=[...e.target.querySelectorAll('[name="application[]"]')].map(x=>x.value);
  if(d.id)dataManager.editProduct(d.id,d);else dataManager.addProduct(d);
  closeAdminModal('adminProductModal');alert('Product saved');
};
document.getElementById('categoryForm').onsubmit=async(e)=>{
  e.preventDefault();const f=new FormData(e.target),d=Object.fromEntries(f);
  if(d.id)dataManager.editCategory(d.id,d);else dataManager.addCategory(d);
  closeAdminModal('adminCategoryModal');alert('Category saved');
};
document.getElementById('projectForm').onsubmit=async(e)=>{
  e.preventDefault();const f=new FormData(e.target),d=Object.fromEntries(d);
  if(d.id)dataManager.editProject(d.id,d);else dataManager.addProject(d);
  closeAdminModal('adminProjectModal');alert('Project saved');
};
document.getElementById('inquiryEditForm').onsubmit=saveContactSettings;

/* ----------  EXISTING HELPERS  ---------- */
function handleFileUpload(inp,type){ /* …your existing code… */ }
function removeMedia(id){document.getElementById(id).value='';document.getElementById(id+'Preview').innerHTML='';}
function addSpecificationField(){ /* …your existing code… */ }
function addApplicationField(){ /* …your existing code… */ }
function removeField(btn){btn.parentElement.remove();}

/* ----------  SEARCH / FILTER  ---------- */
document.getElementById('searchInput').addEventListener('input',e=>{if(e.target.value)e.target.dispatchEvent(new KeyboardEvent('keypress',{key:'Enter'}));});
document.getElementById('searchInput').addEventListener('keypress',e=>{if(e.key==='Enter')searchProducts();});

/* ----------  MENU NAV  ---------- */
document.querySelectorAll('.menu-link').forEach(lnk=>{
  lnk.addEventListener('click',e=>{
    e.preventDefault();document.querySelectorAll('.menu-link').forEach(x=>x.classList.remove('active'));
    lnk.classList.add('active');document.querySelectorAll('.content-section').forEach(s=>s.classList.remove('active'));
    const tgt=document.getElementById(lnk.dataset.section); tgt.classList.add('active');
    document.getElementById('pageTitle').textContent=lnk.querySelector('span').textContent;
    if(tgt.id==='products')dataManager.renderProductsAdmin();
    if(tgt.id==='categories')dataManager.renderCategoriesAdmin();
    if(tgt.id==='innovation')dataManager.renderProjectsAdmin();
    if(tgt.id==='inquiries')dataManager.renderInquiriesAdmin();
    if(tgt.id==='contacts')dataManager.loadContactSettings();
  });
});

/* ----------  OUTSIDE-CLICK CLOSE  ---------- */
window.onclick=e=>{
  if(e.target.classList.contains('modal')||e.target.classList.contains('admin-modal')||e.target.classList.contains('quote-modal'))
    e.target.style.display='none';
};
</script>
<!-- ==========  /SUPABASE  ========== -->
